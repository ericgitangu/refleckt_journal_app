# AWS Lambda Build System with cargo-lambda

This document explains the approach used for building the Refleckt Journal App backend services for AWS Lambda.

## Overview

We've implemented a build system that uses `cargo-lambda` for AWS Lambda function compilation and packaging. This approach has several advantages:

1. **Specialized for Lambda**: `cargo-lambda` is purpose-built for AWS Lambda development
2. **Simplified Workflow**: Handles both compilation and packaging in a single step
3. **ARM64 Only**: Standardizes on ARM64 (aarch64) architecture for better performance and cost
4. **Architecture-Specific Settings**: Proper handling of ARM64 vs x86_64 compilation differences
5. **Consistent Version**: Pins the Rust version to 1.84.0 across all services
6. **No Root Required**: Tools are installed locally within the project directory

## Key Components

### 1. Rust Toolchain Files

Each service has a consistent `rust-toolchain.toml` file that:
- Pins the Rust version to 1.84.0
- Includes necessary components (rustfmt, clippy)
- Specifies only the ARM64 target (aarch64-unknown-linux-musl)
- Uses the minimal profile for faster installation

```toml
[toolchain]
channel = "1.84.0"
components = ["rustfmt", "clippy"]
targets = ["aarch64-unknown-linux-musl"]
profile = "minimal"
```

### 2. Architecture-Specific Cargo Configuration

The `.cargo/config.toml` file contains architecture-specific settings:

```toml
[build]
rustflags = []

[env]
# Empty default environment

# ARM specific settings
[target.aarch64-unknown-linux-musl]
rustflags = []
# ARM-specific compiler config
env = { "CC_aarch64_unknown_linux_musl" = "clang", "AR_aarch64_unknown_linux_musl" = "llvm-ar", "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_RUSTFLAGS" = "-Clink-self-contained=yes -Clinker=rust-lld" }

# x86_64 specific settings - disable AVX512
[target.x86_64-unknown-linux-gnu]
rustflags = ["-C", "target-feature=-avx512f"]
env = { "CFLAGS" = "-mno-avx512f" }
```

Key differences:
- **For ARM64**: Uses clang and llvm-ar, as recommended for the `ring` crate
- **For x86_64**: Disables AVX512 instructions to avoid compatibility issues

### 3. Build System

The build system includes:
- `build-all.sh`: Single build script that builds all services using cargo-lambda
- `init.sh`: Sets up the Lambda build environment with architecture-specific settings
- `setup-aarch64-tools.sh`: Installs the necessary tools locally for ARM64 builds
- `setup-toolchain.sh`: Ensures all services have consistent toolchain configuration
- `setup-env.sh`: Generated by setup script to set the correct environment variables
- Makefile: Provides easy-to-use commands for building and deploying

## Fixing the ARM64 `ring` Crate Issues

A common issue when building for `aarch64-unknown-linux-musl` is the incompatibility of the `ring` crate with default compiler settings. We've addressed this by:

1. Using clang/LLVM toolchain for ARM64 builds instead of GCC
2. Setting specific environment variables required by the ring crate
3. Removing x86_64-specific AVX512 flags that cause errors on ARM
4. Installing tools locally within the project directory without requiring root privileges

These changes allow the `ring` crate to compile correctly on ARM64 architectures.

## ARM64-Only Approach

We've standardized on ARM64 (aarch64) as our exclusive target architecture for several reasons:

1. **Cost Efficiency**: ARM64 Lambda functions are ~20% cheaper than x86_64
2. **Better Performance**: Often provides better performance per dollar
3. **Native Mac Support**: Works better with Apple Silicon (M1/M2/M3) Macs
4. **Fewer Compatibility Issues**: Avoids some x86_64-specific issues (like AVX512)
5. **Future-Proof**: AWS is heavily investing in ARM-based solutions
6. **Simplified Setup**: By standardizing on one architecture, we avoid complexity and potential issues

## Local Tools Installation

To avoid requiring root/sudo privileges, we've designed the toolchain to install everything locally:

1. Tools are installed to `.local/bin` within the project directory
2. Environment variables are set automatically in the current shell
3. A `setup-env.sh` script is generated for sourcing in new shells
4. Build scripts detect and use the local tools automatically

This approach works on both macOS and Linux without requiring any system-wide installation.

## Maintaining Consistent Toolchain Files

To ensure all services have the correct toolchain configuration, we've created a setup script:

```bash
# Apply consistent toolchain files to all services
cd backend
./scripts/setup-toolchain.sh
```

This script verifies and updates the rust-toolchain.toml file in each service directory.

## How to Build

### Setting Up Tools

To set up the required tools:

```bash
cd backend
./scripts/setup-aarch64-tools.sh
source setup-env.sh  # If you open a new terminal
```

This script:
- Downloads and installs LLVM/clang to the local `.local/bin` directory
- Creates a `setup-env.sh` script with the necessary environment variables
- Does NOT require root/sudo privileges
- Sets the PATH to include the local tools directory

### Building All Services

```bash
cd backend
make build-all
```

### Building a Specific Service

```bash
cd backend
make build-lambda-SERVICE
```

Replace `SERVICE` with the service name (e.g., `ai-service`, `entry-service`, etc.).

## Troubleshooting

### ARM64-Specific Issues

If you encounter build failures with the `ring` crate on ARM64:

1. Make sure you've run `./scripts/setup-aarch64-tools.sh` to install clang/LLVM locally
2. Ensure the environment is set up correctly by sourcing `source setup-env.sh`
3. Verify the correct environment variables are set:
   - CC_aarch64_unknown_linux_musl=clang
   - AR_aarch64_unknown_linux_musl=llvm-ar
   - CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_RUSTFLAGS
4. Check that the PATH includes the local tools directory: `echo $PATH | grep .local/bin`

### General Issues

1. **Missing Toolchain Files**: Run `./scripts/setup-toolchain.sh` to ensure all services have the correct configuration
2. **Version Mismatch**: Verify that Rust 1.84.0 is installed with `rustup toolchain list`
3. **Build Logs**: Check the logs in `backend/build-logs/` for detailed error information

## Resources

- [cargo-lambda Documentation](https://www.cargo-lambda.info/)
- [AWS Lambda Rust Runtime](https://github.com/awslabs/aws-lambda-rust-runtime)
- [Ring Crate ARM64 Issue Thread](https://github.com/briansmith/ring/issues/1414)
- [AWS Lambda Graviton2 Processors](https://aws.amazon.com/blogs/aws/aws-lambda-functions-powered-by-aws-graviton2-processor-run-your-functions-on-arm-and-get-up-to-34-better-price-performance/) 